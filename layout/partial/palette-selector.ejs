<% if (theme.sidebar?.palette_selector?.enabled) { %>
<%
  var palettes = palette_list ? palette_list() : [],
    pSelector = (theme.sidebar && theme.sidebar.palette_selector) ? theme.sidebar.palette_selector : {},
    defaultDark = pSelector.default_dark || 'solar-amber',
    defaultLight = pSelector.default_light || 'paper-and-ink';
%>
<script>
  window.FLUX_DATA = {
    palettes: <%- JSON.stringify(palettes) %>,
    defaultLight: "<%= defaultLight %>",
    defaultDark: "<%= defaultDark %>"
  };
</script>
<script src="<%= url_for('/js/palette-switcher.js') %>"></script>
<div class="sidebar-section" x-data="sidebarSection('palette')">
  <h3 @click="toggle">
    <span>Palette</span>
    <span x-text="open ? '-' : '+'"></span>
  </h3>
  <div id="sb-palette" class="palette-switcher" x-data="paletteSwitcher()" x-show="open" x-collapse>
    <div style="display:flex; flex-direction:column; width:100%; gap:0.5rem;">
      <select id="palette-select" x-model="currentPalette">
        <option value="auto">Auto (System)</option>
        <option value="custom">Custom (Flux)</option>
        <% palettes.forEach(function(p) { %>
        <option value="<%= p.key %>"><%= (p.name || p.key) + (p.mode === 'light' ? ' (Light)' : '') %></option>
        <% }); %>
      </select>
      <div x-show="currentPalette === 'custom'" x-transition class="palette-controls">
        <div class="palette-row">
          <label for="cp-input" class="palette-label">Accent</label>
          <div class="color-swatch-container">
            <input id="cp-input" type="color" x-model="customColor" class="color-input">
            <div class="color-swatch" :style="'background-color: ' + customColor"></div>
          </div>
        </div>
        <div class="palette-row">
          <label for="cp-bg-input" class="palette-label">Background</label>
          <div class="color-swatch-container">
            <input id="cp-bg-input" type="color" :value="customBgColor" @input="handleBgInput" class="color-input">
            <div class="color-swatch" :style="'background-color: ' + customBgColor"></div>
          </div>
        </div>
        <div class="palette-row">
          <label class="palette-label">Mode</label>
          <div class="mode-group">
            <label class="auto-label">
              <input type="checkbox" x-model="isAuto" style="cursor:pointer;">
              Auto
            </label>
            <button type="button" @click="toggleMode" :disabled="isAuto" class="mode-btn" aria-label="Toggle Dark Mode" :style="'opacity: ' + (isAuto ? 0.4 : 1) + '; cursor: ' + (isAuto ? 'default' : 'pointer')">
              <svg x-show="isDark" class="mode-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;" :style="{ 'display': isDark ? 'block' : 'none' }">
                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
              </svg>
              <svg x-show="!isDark" class="mode-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none;" :style="{ 'display': !isDark ? 'block' : 'none' }">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
              </svg>
            </button>
          </div>
        </div>
        <div class="palette-input-col">
          <label for="cp-name" class="palette-label">Name</label>
          <input id="cp-name" type="text" x-model="paletteName" placeholder="e.g. My Custom Theme" class="palette-text-input">
        </div>
        <button type="button" @click="exportPalette" class="palette-export-btn">
          Export to CSS
        </button>
      </div>
    </div>
  </div>
  <script>
    (function() {
      var stored = sessionStorage.getItem('flux-sidebar-palette');
      if (stored === 'false')
        document.getElementById('sb-palette').style.display = 'none';
    })();
  </script>
</div>
<% } %>